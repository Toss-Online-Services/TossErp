# PostgreSQL Primary Configuration for TOSS ERP III
# Optimized for performance, reliability, and replication

# Connection Settings
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# Memory Settings
shared_buffers = 256MB              # 25% of available RAM (adjust based on container limits)
effective_cache_size = 1GB          # Estimate of OS cache size
work_mem = 4MB                      # Per-operation sort/hash memory
maintenance_work_mem = 64MB         # Memory for maintenance operations
autovacuum_work_mem = 64MB          # Memory for autovacuum workers

# Write-Ahead Logging (WAL) Settings for Replication
wal_level = replica                 # Enable replication
wal_log_hints = on                  # Required for pg_rewind
max_wal_senders = 5                 # Max replication connections
wal_keep_size = 32                  # Keep WAL segments (in MB)
archive_mode = on                   # Enable WAL archiving
archive_command = 'test ! -f /var/lib/postgresql/wal_archive/%f && cp %p /var/lib/postgresql/wal_archive/%f'

# Checkpoints and Background Writer
checkpoint_completion_target = 0.9  # Spread checkpoint I/O
checkpoint_timeout = 15min          # Maximum time between checkpoints
max_wal_size = 2GB                  # WAL size trigger for checkpoint
min_wal_size = 512MB                # Minimum WAL size to keep

# Background Writer Settings
bgwriter_delay = 200ms              # Delay between background writer rounds
bgwriter_lru_maxpages = 100         # Max pages written per round
bgwriter_lru_multiplier = 2.0       # Multiplier for next round estimate

# Query Planner Settings
random_page_cost = 1.1              # SSD-optimized setting
effective_io_concurrency = 200      # Concurrent I/O operations
seq_page_cost = 1.0                 # Sequential page cost
cpu_tuple_cost = 0.01               # CPU cost per tuple
cpu_index_tuple_cost = 0.005        # CPU cost per index tuple
cpu_operator_cost = 0.0025          # CPU cost per operator

# Logging Settings
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000   # Log slow queries (1 second)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_lock_waits = on                 # Log lock waits
log_statement = 'ddl'               # Log DDL statements
log_temp_files = 10MB               # Log temp files > 10MB

# Auto-vacuum Settings
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = 200

# Statistics Settings
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl                # Track stored procedure stats
stats_temp_directory = 'pg_stat_tmp'

# Locale and Text Search
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'
default_text_search_config = 'pg_catalog.english'

# Time Zone
timezone = 'UTC'
log_timezone = 'UTC'

# Hot Standby Settings (for replicas)
hot_standby = on
max_standby_archive_delay = 30s
max_standby_streaming_delay = 30s
wal_receiver_status_interval = 10s
hot_standby_feedback = on

# Security Settings
ssl = off                           # Disable for development (enable in production)
password_encryption = scram-sha-256
row_security = on                   # Enable Row Level Security

# Shared Preload Libraries
shared_preload_libraries = 'pg_stat_statements'

# Extension Settings
pg_stat_statements.max = 1000
pg_stat_statements.track = all
