@page "/"
@using TossErp.Application.DTOs
@using TossErp.Application.Services
@* @inject IProductService ProductService *@
@* @inject ISaleService SaleService *@
@* @inject IGroupPurchaseService GroupPurchaseService *@
@inject NavigationManager Navigation

<PageTitle>TOSS ERP III - Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <!-- Welcome Section -->
    <MudPaper Class="pa-4 mb-4" Elevation="1">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            <MudAvatar Size="Size.Large" Color="Color.Primary">
                <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Large" />
            </MudAvatar>
            <MudStack>
                <MudText Typo="Typo.h4" Color="Color.Primary">Welcome to TOSS ERP III</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Your cooperative economy platform for township and rural SMMEs
                </MudText>
            </MudStack>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="@(() => Navigation.NavigateTo("/pos"))"
                      StartIcon="@Icons.Material.Filled.PointOfSale">
                Start POS Sale
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Key Metrics Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudAvatar Color="Color.Success" Size="Size.Small">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" />
                    </MudAvatar>
                    <MudStack Class="flex-grow-1">
                        <MudText Typo="Typo.h6">@_todaySales.ToString("C")</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Today's Sales</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudAvatar Color="Color.Info" Size="Size.Small">
                        <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" />
                    </MudAvatar>
                    <MudStack Class="flex-grow-1">
                        <MudText Typo="Typo.h6">@_todayOrders</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Today's Orders</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudAvatar Color="Color.Warning" Size="Size.Small">
                        <MudIcon Icon="@Icons.Material.Filled.Inventory" />
                    </MudAvatar>
                    <MudStack Class="flex-grow-1">
                        <MudText Typo="Typo.h6">@_lowStockItems</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Low Stock Items</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Elevation="1">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudAvatar Color="Color.Tertiary" Size="Size.Small">
                        <MudIcon Icon="@Icons.Material.Filled.GroupWork" />
                    </MudAvatar>
                    <MudStack Class="flex-grow-1">
                        <MudText Typo="Typo.h6">@_activeGroupsCount</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Active Groups</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Charts and Analytics -->
    <MudGrid Class="mb-4">
        <!-- Sales Chart -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Sales Trend (Last 7 Days)</MudText>
                <MudChart ChartType="ChartType.Line" ChartSeries="@_salesData" XAxisLabels="@_dateLabels" Width="100%" Height="300px" />
            </MudPaper>
        </MudItem>
        
        <!-- Top Products -->
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Top Selling Products</MudText>
                <MudList Dense="true">
                    @foreach (var product in _topProducts)
                    {
                        <MudListItem>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Size="Size.Small" Color="Color.Primary">
                                    <MudIcon Icon="@Icons.Material.Filled.Category" />
                                </MudAvatar>
                                <MudStack Class="flex-grow-1">
                                    <MudText Typo="Typo.body2">@product.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @product.QuantitySold sold
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Quick Actions -->
    <MudGrid Class="mb-4">
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Quick Actions</MudText>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="2" Class="ma-2" Style="cursor: pointer;" OnClick="@(() => Navigation.NavigateTo("/pos"))">
                            <MudCardContent>
                                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.PointOfSale" Size="Size.Large" Color="Color.Primary" />
                                    <MudText Typo="Typo.h6">Point of Sale</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Process sales transactions</MudText>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="2" Class="ma-2" Style="cursor: pointer;" OnClick="@(() => Navigation.NavigateTo("/products"))">
                            <MudCardContent>
                                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Large" Color="Color.Secondary" />
                                    <MudText Typo="Typo.h6">Manage Inventory</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Add/edit products</MudText>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="2" Class="ma-2" Style="cursor: pointer;" OnClick="@(() => Navigation.NavigateTo("/create-group"))">
                            <MudCardContent>
                                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.GroupWork" Size="Size.Large" Color="Color.Tertiary" />
                                    <MudText Typo="Typo.h6">Create Group</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Start group purchase</MudText>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="3">
                        <MudCard Elevation="2" Class="ma-2" Style="cursor: pointer;" OnClick="@(() => Navigation.NavigateTo("/vendors"))">
                            <MudCardContent>
                                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Large" Color="Color.Info" />
                                    <MudText Typo="Typo.h6">Vendor Directory</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Browse suppliers</MudText>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- Recent Activity -->
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Recent Sales</MudText>
                <MudList Dense="true">
                    @foreach (var sale in _recentSales)
                    {
                        <MudListItem>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Size="Size.Small" Color="Color.Success">
                                    <MudIcon Icon="@Icons.Material.Filled.Receipt" />
                                </MudAvatar>
                                <MudStack Class="flex-grow-1">
                                    <MudText Typo="Typo.body2">Sale #@sale.SaleNumber</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @sale.TotalAmount.ToString("C") - @sale.SaleDate.ToString("MMM dd, HH:mm")
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4" Elevation="1">
                <MudText Typo="Typo.h6" Class="mb-3">Active Group Purchases</MudText>
                <MudList Dense="true">
                    @foreach (var group in _activeGroupPurchases)
                    {
                        <MudListItem>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Size="Size.Small" Color="Color.Tertiary">
                                    <MudIcon Icon="@Icons.Material.Filled.GroupWork" />
                                </MudAvatar>
                                <MudStack Class="flex-grow-1">
                                    <MudText Typo="Typo.body2">@group.Name</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @group.MemberCount members - Ends @group.EndDate.ToString("MMM dd")
                                    </MudText>
                                </MudStack>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private decimal _todaySales = 1250.50m;
    private int _todayOrders = 8;
    private int _lowStockItems = 3;
    private int _activeGroupsCount = 2;
    
    private List<ChartSeries> _salesData = new();
    private string[] _dateLabels = new string[7];
    private List<TopProductDto> _topProducts = new();
    private List<SaleDto> _recentSales = new();
    private List<GroupPurchaseDto> _activeGroupPurchases = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Mock data for now
            _salesData = new List<ChartSeries>
            {
                new ChartSeries { Name = "Sales", Data = new double[] { 1200, 1350, 1100, 1400, 1250, 1600, 1450 } }
            };
            _dateLabels = new string[] { "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" };

            _topProducts = new List<TopProductDto>
            {
                new TopProductDto { Id = Guid.NewGuid(), Name = "Product A", QuantitySold = 25, TotalRevenue = 500.00m },
                new TopProductDto { Id = Guid.NewGuid(), Name = "Product B", QuantitySold = 20, TotalRevenue = 400.00m },
                new TopProductDto { Id = Guid.NewGuid(), Name = "Product C", QuantitySold = 15, TotalRevenue = 300.00m }
            };

            _recentSales = new List<SaleDto>
            {
                new SaleDto(Guid.NewGuid(), "SALE-001", Guid.NewGuid(), null, 150.00m, 22.50m, 0m, 172.50m, "Cash", "completed", "completed", DateTime.Now.AddHours(-1), null, null, false, null, new List<SaleItemDto>(), new List<PaymentTransactionDto>()),
                new SaleDto(Guid.NewGuid(), "SALE-002", Guid.NewGuid(), null, 200.00m, 30.00m, 0m, 230.00m, "Card", "completed", "completed", DateTime.Now.AddHours(-2), null, null, false, null, new List<SaleItemDto>(), new List<PaymentTransactionDto>()),
                new SaleDto(Guid.NewGuid(), "SALE-003", Guid.NewGuid(), null, 175.00m, 26.25m, 0m, 201.25m, "Cash", "completed", "completed", DateTime.Now.AddHours(-3), null, null, false, null, new List<SaleItemDto>(), new List<PaymentTransactionDto>())
            };

            _activeGroupPurchases = new List<GroupPurchaseDto>
            {
                new GroupPurchaseDto { Id = Guid.NewGuid(), GroupNumber = "GP-001", BusinessId = Guid.NewGuid(), ProductId = Guid.NewGuid(), ProductName = "Group A", UnitPrice = 100m, GroupPrice = 80m, MinimumQuantity = 5, TargetQuantity = 10, CurrentQuantity = 5, Status = "Active", ExpiryDate = DateTime.Now.AddDays(7), CreatedAt = DateTime.Now, CreatedBy = Guid.NewGuid(), MemberCount = 5, CurrentAmount = 400m, TargetAmount = 800m, EndDate = DateTime.Now.AddDays(7) },
                new GroupPurchaseDto { Id = Guid.NewGuid(), GroupNumber = "GP-002", BusinessId = Guid.NewGuid(), ProductId = Guid.NewGuid(), ProductName = "Group B", UnitPrice = 150m, GroupPrice = 120m, MinimumQuantity = 3, TargetQuantity = 8, CurrentQuantity = 3, Status = "Active", ExpiryDate = DateTime.Now.AddDays(3), CreatedAt = DateTime.Now, CreatedBy = Guid.NewGuid(), MemberCount = 3, CurrentAmount = 360m, TargetAmount = 960m, EndDate = DateTime.Now.AddDays(3) }
            };
        }
        catch (Exception ex)
        {
            // Handle error
        }
    }
} 