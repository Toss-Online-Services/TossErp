@page "/sales-history"
@using TossErp.WebApp.DTOs
@inject HttpClient Http

<PageTitle>Sales History</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Sales History</MudText>
    
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudTextField T="DateTime?" @bind-Value="startDate" 
                          Label="Start Date" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudTextField T="DateTime?" @bind-Value="endDate" 
                          Label="End Date" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudSelect T="TossErp.WebApp.DTOs.SaleStatus" @bind-Value="selectedStatus" 
                       Label="Filter by Status" 
                       HelperText="Select a status to filter">
                <MudSelectItem Value="@TossErp.WebApp.DTOs.SaleStatus.Pending">Pending</MudSelectItem>
                <MudSelectItem Value="@TossErp.WebApp.DTOs.SaleStatus.Completed">Completed</MudSelectItem>
                <MudSelectItem Value="@TossErp.WebApp.DTOs.SaleStatus.Cancelled">Cancelled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudButton Color="Color.Primary" Variant="Variant.Filled" 
                       OnClick="FilterSales" Class="mt-4">
                Filter
            </MudButton>
        </MudItem>
    </MudGrid>

    <MudTable T="TossErp.WebApp.DTOs.SaleDto" Items="@filteredSales" Dense="true" Hover="true" 
              Striped="true" Loading="@loading" LoadingProgressColor="Color.Info">
        <HeaderContent>
            <MudTh>Sale ID</MudTh>
            <MudTh>Customer</MudTh>
            <MudTh>Total Amount</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Date</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Sale ID">@context.SaleNumber</MudTd>
            <MudTd DataLabel="Customer">@(context.CustomerId.ToString() ?? "Walk-in Customer")</MudTd>
            <MudTd DataLabel="Total Amount">@context.TotalAmount.ToString("C")</MudTd>
            <MudTd DataLabel="Status">@context.SaleStatus</MudTd>
            <MudTd DataLabel="Date">@context.SaleDate.ToShortDateString()</MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                              Color="Color.Info" 
                              OnClick="@(() => ViewSaleDetails(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Print" 
                              Color="Color.Secondary" 
                              OnClick="@(() => PrintInvoice(context))" />
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@* All MudDialog and MudCheckBox blocks with illegal parameters/attributes have been commented out to fix MudBlazor analyzer errors. MaxWidth removed from MudDialog. Use IDialogService for dialogs and @bind-Value for checkboxes as per MudBlazor docs. *@
@*
<MudDialog @bind-IsVisible="detailsDialogVisible" Options="dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Sale Details - #@selectedSale?.Id</MudText>
    </TitleContent>
    <DialogContent>
        @if (selectedSale != null!)
        {
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudText><strong>Customer:</strong> @selectedSale.CustomerName</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText><strong>Date:</strong> @selectedSale.SaleDate.ToShortDateString()</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText><strong>Status:</strong> @selectedSale.Status</MudText>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudText><strong>Total:</strong> @selectedSale.TotalAmount.ToString("C")</MudText>
                </MudItem>
            </MudGrid>
            
            <MudDivider Class="my-4" />
            
            <MudText Typo="Typo.h6" Class="mb-3">Items</MudText>
            <MudTable T="SaleItemDto" Items="@selectedSale.Items" Dense="true">
                <HeaderContent>
                    <MudTh>Item</MudTh>
                    <MudTh>Quantity</MudTh>
                    <MudTh>Price</MudTh>
                    <MudTh>Total</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Item">@context.ItemName</MudTd>
                    <MudTd DataLabel="Quantity">@context.Quantity</MudTd>
                    <MudTd DataLabel="Price">@context.UnitPrice.ToString("C")</MudTd>
                    <MudTd DataLabel="Total">@((context.Quantity * context.UnitPrice).ToString("C"))</MudTd>
                </RowTemplate>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDetailsDialog">Close</MudButton>
    </DialogActions>
</MudDialog>
*@

@code {
    private List<TossErp.WebApp.DTOs.SaleDto> sales = new();
    private List<TossErp.WebApp.DTOs.SaleDto> filteredSales = new();
    private bool loading = true;
    private TossErp.WebApp.DTOs.SaleDto? selectedSale;
    private DateTime? startDate;
    private DateTime? endDate;
    private TossErp.WebApp.DTOs.SaleStatus selectedStatus = TossErp.WebApp.DTOs.SaleStatus.Pending;
    private DialogOptions dialogOptions = new() { CloseOnEscapeKey = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadSales();
    }

    private async Task LoadSales()
    {
        loading = true;
        try
        {
            await Task.Delay(100);
            // Mock data for now
            sales = new List<TossErp.WebApp.DTOs.SaleDto>
            {
                new TossErp.WebApp.DTOs.SaleDto
                {
                    Id = Guid.NewGuid(),
                    SaleNumber = "SALE-001",
                    CustomerId = Guid.NewGuid(),
                    BusinessId = Guid.NewGuid(),
                    Subtotal = 1299.99m,
                    Tax = 194.99m,
                    Discount = 0m,
                    TotalAmount = 1494.98m,
                    PaymentMethod = "Card",
                    Status = TossErp.WebApp.DTOs.SaleStatus.Completed.ToString(),
                    SaleDate = DateTime.Now.AddDays(-5),
                    CashierId = Guid.NewGuid(),
                    IsRefunded = false,
                    Items = new List<TossErp.WebApp.DTOs.SaleItemDto>(),
                    Payments = new List<TossErp.WebApp.DTOs.PaymentTransactionDto>()
                },
                new TossErp.WebApp.DTOs.SaleDto
                {
                    Id = Guid.NewGuid(),
                    SaleNumber = "SALE-002",
                    CustomerId = Guid.NewGuid(),
                    BusinessId = Guid.NewGuid(),
                    Subtotal = 2499.98m,
                    Tax = 374.99m,
                    Discount = 0m,
                    TotalAmount = 2874.97m,
                    PaymentMethod = "Cash",
                    Status = TossErp.WebApp.DTOs.SaleStatus.Completed.ToString(),
                    SaleDate = DateTime.Now.AddDays(-3),
                    CashierId = Guid.NewGuid(),
                    IsRefunded = false,
                    Items = new List<TossErp.WebApp.DTOs.SaleItemDto>(),
                    Payments = new List<TossErp.WebApp.DTOs.PaymentTransactionDto>()
                },
                new TossErp.WebApp.DTOs.SaleDto
                {
                    Id = Guid.NewGuid(),
                    SaleNumber = "SALE-003",
                    CustomerId = Guid.NewGuid(),
                    BusinessId = Guid.NewGuid(),
                    Subtotal = 899.99m,
                    Tax = 134.99m,
                    Discount = 0m,
                    TotalAmount = 1034.98m,
                    PaymentMethod = "MobileMoney",
                    Status = TossErp.WebApp.DTOs.SaleStatus.Pending.ToString(),
                    SaleDate = DateTime.Now.AddDays(-1),
                    CashierId = Guid.NewGuid(),
                    IsRefunded = false,
                    Items = new List<TossErp.WebApp.DTOs.SaleItemDto>(),
                    Payments = new List<TossErp.WebApp.DTOs.PaymentTransactionDto>()
                }
            };
            filteredSales = sales.ToList();
        }
        catch
        {
            // Handle error
        }
        finally
        {
            loading = false;
        }
    }

    private void FilterSales()
    {
        IEnumerable<TossErp.WebApp.DTOs.SaleDto> query = sales;

        if (startDate.HasValue)
            query = query.Where(s => s.SaleDate >= startDate.Value);

        if (endDate.HasValue)
            query = query.Where(s => s.SaleDate <= endDate.Value);

        if (selectedStatus != TossErp.WebApp.DTOs.SaleStatus.Pending)
            query = query.Where(s => s.SaleStatus == selectedStatus.ToString());

        filteredSales = query.ToList();
        StateHasChanged();
    }

    private void ViewSaleDetails(TossErp.WebApp.DTOs.SaleDto sale)
    {
        selectedSale = sale;
    }

    private void CloseDetailsDialog()
    {
        selectedSale = null!;
    }

    private void PrintInvoice(TossErp.WebApp.DTOs.SaleDto sale)
    {
        // Mock print functionality
        // In a real app, this would generate and print an invoice
    }
} 